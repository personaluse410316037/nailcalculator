<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>美甲收費計算機</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center; /* 內容置中 */
      justify-content: center;
      min-height: 100vh;
      background-color: #f0f0f0;
      margin: 0;
      padding: 20px;
    }
    h1 {
      font-size: 2.5em; /* 標題文字放大 */
      color: #333;
    }
    label, input, button {
      font-size: 1.5em; /* 選項和按鈕文字放大 */
      margin: 10px 0;
    }
    button {
      padding: 10px 20px;
      border-radius: 5px;
      background-color: #ff6f61;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #e55a50;
    }
    .delete-btn {
      background-color: #e55a50;
      font-size: 1.2em;
      padding: 5px 10px;
    }
    .delete-btn:hover {
      background-color: #c7463e;
    }
    .result-container {
      text-align: left;
      width: 100%;
      max-width: 500px;
    }
    #result {
      font-size: 2.2em; /* 總計文字放大 */
      font-weight: bold; /* 總計加粗 */
      color: #333;
    }
    #explanation {
      font-size: 1.8em; /* 收費明細文字放大 */
      color: #333;
    }
    .detail-item {
      text-align: right; /* 細項和數字置右 */
    }
    .note {
      font-size: 1.4em; /* 括號內容小一號 */
    }
    .container {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 500px;
    }
    hr {
      border: 1px solid #ccc;
      margin: 20px 0;
    }
    .section-title {
      font-size: 1.6em;
      color: #555;
      margin: 10px 0;
    }
    table {
      width: 100%;
      max-width: 500px;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      font-size: 1.4em;
    }
    th {
      background-color: #f5f5f5;
    }
    .record-detail {
      white-space: pre-wrap; /* 保留換行 */
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>美甲收費計算機</h1>
    
    <div class="section-title">選擇主要服務</div>
    <label><input type="checkbox" id="nail"> 美甲 ($100)</label><br>
    <label><input type="checkbox" id="manicure"> 修甲 ($80)</label><br>
    <label><input type="checkbox" id="eyelash"> 美眼睫毛 ($120)</label><br>
    
    <hr> <!-- 分隔線 -->
    
    <div class="section-title">附加服務</div>
    <label><input type="checkbox" id="complex"> 複雜彩繪 (+$20)</label><br>
    <label><input type="checkbox" id="gelAdd"> 凝膠加成 (+50%)</label><br>
    <label><input type="checkbox" id="premiumColor"> 尊貴顏色 (+$20)</label><br>
    
    <hr> <!-- 分隔線 -->
    
    <div class="section-title">折扣</div>
    <label><input type="checkbox" id="firstTime"> 首次優惠 (-$10)</label><br>
    <label><input type="checkbox" id="bundle"> 疊加優惠 (僅收最貴的附加服務費用)</label><br>
    
    <button onclick="calculate()">計算費用</button>
    <button onclick="addRecord()">加入記錄</button>
    <div class="result-container">
      <p id="result">總計: $0</p>
      <p id="explanation">收費明細：請選擇服務</p>
    </div>
  </div>

  <div class="section-title">記錄</div>
  <table id="recordTable">
    <thead>
      <tr>
        <th>日期</th>
        <th>收費明細</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="recordBody"></tbody>
  </table>

  <script>
    // 初始化記錄（從 localStorage 或 Google Sheets 載入）
    let records = JSON.parse(localStorage.getItem('nailRecords')) || [];
    renderRecords();

    function calculate() {
      let total = 0;
      let explanation = "收費明細：<br>";
      let addOnFees = [];
      let servicesSelected = false;

      // 主要服務
      if (document.getElementById("nail").checked) {
        total += 100;
        explanation += '<span class="detail-item">美甲 $100</span><br>';
        servicesSelected = true;
      }
      if (document.getElementById("manicure").checked) {
        total += 80;
        explanation += '<span class="detail-item">修甲 $80</span><br>';
        servicesSelected = true;
      }
      if (document.getElementById("eyelash").checked) {
        total += 120;
        explanation += '<span class="detail-item">美眼睫毛 $120</span><br>';
        servicesSelected = true;
      }

      // 如果沒有選擇主要服務
      if (!servicesSelected) {
        document.getElementById("result").innerText = "總計: $0";
        document.getElementById("explanation").innerHTML = "收費明細：請選擇至少一項主要服務";
        return;
      }

      // 附加服務
      let baseTotal = total; // 儲存基礎總額以計算凝膠加成
      if (document.getElementById("complex").checked) {
        addOnFees.push({ name: "複雜彩繪", fee: 20 });
      }
      if (document.getElementById("premiumColor").checked) {
        addOnFees.push({ name: "尊貴顏色", fee: 20 });
      }
      if (document.getElementById("gelAdd").checked) {
        let gelFee = baseTotal * 0.5;
        addOnFees.push({ name: "凝膠加成", fee: gelFee });
      }

      // 疊加優惠：僅收最貴的附加服務
      if (document.getElementById("bundle").checked && addOnFees.length > 1) {
        let maxFee = Math.max(...addOnFees.map(item => item.fee));
        let maxFeeItem = addOnFees.find(item => item.fee === maxFee);
        total += maxFee;
        explanation += `<span class="detail-item">${maxFeeItem.name} $${maxFee}</span><br>`;
        explanation += `<span class="note">(疊加優惠：僅收最貴附加服務)</span><br>`;
      } else {
        // 無疊加優惠，全部附加服務費用相加
        addOnFees.forEach(item => {
          total += item.fee;
          explanation += `<span class="detail-item">${item.name} $${item.fee}</span><br>`;
        });
      }

      // 首次優惠
      if (document.getElementById("firstTime").checked) {
        total -= 10;
        explanation += '<span class="detail-item">首次優惠 -$10</span><br>';
      }

      // 確保總價不為負
      total = Math.max(0, total);

      // 更新顯示
      document.getElementById("result").innerText = `總計: $${total}`;
      document.getElementById("explanation").innerHTML = explanation;

      // 儲存當前計算結果以便加入記錄
      window.currentResult = { total, explanation };
    }

    function addRecord() {
      if (!window.currentResult || !window.currentResult.explanation.includes("detail-item")) {
        alert("請先計算費用並選擇至少一項主要服務！");
        return;
      }

      // 獲取當前日期（香港時間）
      const now = new Date();
      const dateStr = now.toLocaleDateString('zh-HK', { year: 'numeric', month: '2-digit', day: '2-digit' });

      // 準備記錄數據
      const record = {
        date: dateStr,
        explanation: window.currentResult.explanation.replace(/<br>/g, '\n').replace(/<\/?span[^>]*>/g, '')
      };

      // 提交到 Google Forms
      submitToGoogleForm(record);

      // 本地記錄（臨時，待 Google Sheets 同步）
      records.push(record);
      localStorage.setItem('nailRecords', JSON.stringify(records));
      renderRecords();

      // 從 Google Sheets 重新載入記錄
      loadRecordsFromGoogleSheets();
    }

    function submitToGoogleForm(record) {
      const formUrl = "你的 Google Forms 預填寫 URL"; // 需替換為實際 URL
      const formData = new FormData();
      formData.append("entry.你的日期欄位ID", record.date); // 替換為 Google Forms 的日期欄位 ID
      formData.append("entry.你的明細欄位ID", record.explanation); // 替換為 Google Forms 的明細欄位 ID

      fetch(formUrl, {
        method: "POST",
        body: formData,
        mode: "no-cors" // Google Forms 不需要跨域回應
      }).then(() => {
        console.log("記錄已提交到 Google Forms");
      }).catch(error => {
        console.error("提交失敗:", error);
        alert("提交到 Google Forms 失敗，請檢查表單設置");
      });
    }

    function loadRecordsFromGoogleSheets() {
      const sheetUrl = "你的 Google Sheets JSON 端點"; // 需替換為實際 URL
      fetch(sheetUrl)
        .then(response => response.json())
        .then(data => {
          records = data.values.slice(1).map(row => ({
            date: row[0], // 第一列為日期
            explanation: row[1] // 第二列為收費明細
          }));
          localStorage.setItem('nailRecords', JSON.stringify(records));
          renderRecords();
        })
        .catch(error => {
          console.error("載入 Google Sheets 失敗:", error);
          alert("無法載入記錄，請檢查 Google Sheets 設置");
        });
    }

    function renderRecords() {
      const tbody = document.getElementById("recordBody");
      tbody.innerHTML = "";

      records.forEach((record, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${record.date}</td>
          <td class="record-detail">${record.explanation.replace(/\n/g, '<br>')}</td>
          <td><button class="delete-btn" onclick="deleteRecord(${index})">刪除</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function deleteRecord(index) {
      if (confirm("確定要刪除這條記錄嗎？")) {
        if (confirm("請再次確認，刪除後無法恢復！")) {
          // 從 Google Sheets 刪除（透過 Google Apps Script）
          deleteFromGoogleSheets(index);
          
          // 本地刪除
          records.splice(index, 1);
          localStorage.setItem('nailRecords', JSON.stringify(records));
          renderRecords();
        }
      }
    }

    function deleteFromGoogleSheets(index) {
      const scriptUrl = "你的 Google Apps Script 刪除端點"; // 需替換為實際 URL
      fetch(scriptUrl, {
        method: "POST",
        body: JSON.stringify({ row: index + 2 }), // Google Sheets 行數從 2 開始（跳過標題）
        headers: { "Content-Type": "application/json" }
      }).then(() => {
        console.log("從 Google Sheets 刪除成功");
      }).catch(error => {
        console.error("刪除失敗:", error);
        alert("從 Google Sheets 刪除失敗，請檢查 Apps Script 設置");
      });
    }

    // 頁面載入時從 Google Sheets 載入記錄
    window.onload = loadRecordsFromGoogleSheets;
  </script>
</body>
</html>
